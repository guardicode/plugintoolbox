from ipaddress import IPv4Address
from typing import List, Optional, Sequence, Set

import pytest

from common import OperatingSystem
from common.types import NetworkPort, NetworkService, PortStatus
from plugintoolbox import (
    all_tcp_ports_are_closed,
    all_udp_ports_are_closed,
    any_tcp_port_status_is_unknown,
    get_open_tcp_ports,
)
from infection_monkey.i_puppet import PortScanData, PortScanDataDict, TargetHost, TargetHostPorts

TARGET_IP = IPv4Address("127.0.0.1")
PORTS_STATUS = TargetHostPorts(
    tcp_ports=PortScanDataDict(
        {
            NetworkPort(5000): PortScanData(
                port=5000, status=PortStatus.OPEN, service=NetworkService.UNKNOWN
            ),
            NetworkPort(5001): PortScanData(
                port=5001, status=PortStatus.CLOSED, service=NetworkService.SSH
            ),
            NetworkPort(6000): PortScanData(
                port=6000, status=PortStatus.OPEN, service=NetworkService.MSSQL
            ),
            NetworkPort(6001): PortScanData(
                port=6001, status=PortStatus.CLOSED, service=NetworkService.UNKNOWN
            ),
        }
    ),
    udp_ports=PortScanDataDict(
        {
            NetworkPort(7000): PortScanData(port=7000, status=PortStatus.OPEN),
            NetworkPort(7001): PortScanData(port=7001, status=PortStatus.CLOSED),
            NetworkPort(8000): PortScanData(port=8000, status=PortStatus.OPEN),
            NetworkPort(8001): PortScanData(port=8001, status=PortStatus.CLOSED),
        }
    ),
)


@pytest.fixture
def target_host() -> TargetHost:
    return TargetHost(
        ip=TARGET_IP,
        operating_system=OperatingSystem.WINDOWS,
        ports_status=PORTS_STATUS,
    )


@pytest.mark.parametrize(
    "all_ports_are_closed, ports_to_check",
    [(all_tcp_ports_are_closed, [5000, 6000]), (all_udp_ports_are_closed, [7000, 8000])],
)
def test_all_exploitation_ports_open(target_host, all_ports_are_closed, ports_to_check):
    assert not all_ports_are_closed(target_host, ports_to_check)


@pytest.mark.parametrize(
    "all_ports_are_closed, ports_to_check",
    [
        (all_tcp_ports_are_closed, [5000, 5001, 6000, 6001]),
        (all_udp_ports_are_closed, [7000, 7001, 8000, 8001]),
    ],
)
def test_some_exploitation_ports_open(target_host, all_ports_are_closed, ports_to_check):
    assert not all_ports_are_closed(target_host, ports_to_check)


@pytest.mark.parametrize(
    "all_ports_are_closed, ports_to_check",
    [(all_tcp_ports_are_closed, [5001, 6001]), (all_udp_ports_are_closed, [7001, 8001])],
)
def test_all_exploitation_ports_closed(target_host, all_ports_are_closed, ports_to_check):
    assert all_ports_are_closed(target_host, ports_to_check)


@pytest.mark.parametrize(
    "all_ports_are_closed", [(all_tcp_ports_are_closed), (all_udp_ports_are_closed)]
)
def test_no_exploitation_ports_exist(target_host, all_ports_are_closed):
    exploitation_ports: List[NetworkPort] = []

    assert all_ports_are_closed(target_host, exploitation_ports)


@pytest.mark.parametrize(
    "all_ports_are_closed, ports_to_check",
    [(all_tcp_ports_are_closed, [5000, 5001]), (all_udp_ports_are_closed, [7000, 7001])],
)
def test_host_has_no_ports_status(all_ports_are_closed, ports_to_check):
    target_host = TargetHost(
        ip=TARGET_IP,
        operating_system=OperatingSystem.WINDOWS,
        ports_status=PortScanDataDict({}),
    )

    assert not all_ports_are_closed(target_host, ports_to_check)


@pytest.mark.parametrize(
    "network_services, expected_ports",
    [
        ({NetworkService.SSH}, set()),
        ({NetworkService.MSSQL}, {6000}),
        ({NetworkService.UNKNOWN}, {5000}),
        ({NetworkService.MSSQL, NetworkService.SSH, NetworkService.UNKNOWN}, {5000, 6000}),
        (None, {5000, 6000}),
    ],
)
def test_get_open_tcp_ports_by_service(
    target_host: TargetHost, network_services: Optional[Set[NetworkService]], expected_ports
):
    actual_ports = get_open_tcp_ports(target_host, network_services)
    assert actual_ports == expected_ports


@pytest.mark.parametrize(
    "target_ports, expected_value",
    [
        ([], False),
        ([NetworkPort(1), NetworkPort(2)], True),
        ([NetworkPort(5000), NetworkPort(5001)], False),
        ([NetworkPort(1), NetworkPort(5000), NetworkPort(5001)], True),
    ],
)
def test_any_tcp_port_status_is_unknown(
    target_host: TargetHost, target_ports: Sequence[NetworkPort], expected_value: bool
):
    actual_value = any_tcp_port_status_is_unknown(target_host, target_ports)
    assert actual_value == expected_value
